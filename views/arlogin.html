<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rider Dashboard - PoolMate</title>
    <link rel="icon" href="../images/logo.jpg" type="image/png" />
    <link rel="stylesheet" href="/arLogin.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body>
    <header class="dashboard-header">
      <div class="header-container">
        <div class="header-left">
          <div class="logo-container">
            <img src="../images/logo.jpg" class="logo" alt="Logo" />
            <span class="brand-name">PoolMate</span>
          </div>
          <h1 class="page-title">Rider Dashboard</h1>
        </div>

        <div class="header-right">
          <div class="notification-icon">
            <i class="fas fa-bell"></i>
            <span class="notification-badge">0</span>
          </div>

          <div class="profile-dropdown">
            <div class="profile-trigger" id="profileTrigger">
              <img
                src="/api/rider-profile-image"
                alt="Profile"
                class="profile-avatar"
              />
              <span class="profile-name" id="riderProfileName">Loading...</span>
              <i class="fas fa-chevron-down dropdown-arrow"></i>
            </div>
            <div class="dropdown-menu" id="profileDropdown">
              <a href="/rprofile" class="dropdown-item">
                <i class="fas fa-user"></i>
                Profile
              </a>
              <a href="#" class="dropdown-item">
                <i class="fas fa-cog"></i>
                Settings
              </a>
              <a href="#" class="dropdown-item">
                <i class="fas fa-question-circle"></i>
                Help
              </a>
              <div class="dropdown-divider"></div>
              <a href="#" class="dropdown-item logout" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>
                Logout
              </a>
            </div>
          </div>
        </div>
      </div>
    </header>
    <main class="dashboard-main">
      <aside class="dashboard-sidebar">
        <nav class="sidebar-nav">
          <a href="#overview" class="nav-item active" data-section="overview">
            <i class="fas fa-tachometer-alt"></i>
            <span>Overview</span>
          </a>
          <a href="#find-rides" class="nav-item" data-section="find-rides">
            <i class="fas fa-search"></i>
            <span>Find Rides</span>
          </a>
          <a href="#my-rides" class="nav-item" data-section="my-rides">
            <i class="fas fa-route"></i>
            <span>My Rides</span>
            <span class="nav-badge" style="display: none">0</span>
          </a>
          <a href="#ride-history" class="nav-item" data-section="ride-history">
            <i class="fas fa-history"></i>
            <span>Ride History</span>
          </a>
          <a href="#payments" class="nav-item" data-section="payments">
            <i class="fas fa-credit-card"></i>
            <span>Payments</span>
          </a>
          <a href="#favorites" class="nav-item" data-section="favorites">
            <i class="fas fa-heart"></i>
            <span>Favorite Routes</span>
          </a>
        </nav>
      </aside>
      <div class="dashboard-content">
        <section id="overview" class="content-section active">
          <div class="section-header">
            <h2 class="section-title">
              Welcome Back, <span id="welcomeName">User</span>!
            </h2>
            <div class="quick-book-btn">
              <button class="btn-primary" onclick="showSection('find-rides')">
                <i class="fas fa-plus"></i>
                Book a Ride
              </button>
            </div>
          </div>
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-icon rides">
                <i class="fas fa-route"></i>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="totalRides">0</div>
                <div class="stat-label">Total Rides</div>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon savings">
                <i class="fas fa-piggy-bank"></i>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="moneySaved">‚Çπ0</div>
                <div class="stat-label">Money Saved</div>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon rating">
                <i class="fas fa-star"></i>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="userRating">0.0</div>
                <div class="stat-label">Your Rating</div>
              </div>
            </div>

            <div class="stat-card">
              <div class="stat-icon carbon">
                <i class="fas fa-leaf"></i>
              </div>
              <div class="stat-content">
                <div class="stat-value" id="carbonSaved">0kg</div>
                <div class="stat-label">CO‚ÇÇ Saved</div>
              </div>
            </div>
          </div>
          <div class="upcoming-rides">
            <h3 class="section-subtitle">Upcoming Rides</h3>
            <div id="upcomingRidesContainer">
            </div>
          </div>
          <div class="recent-activity">
            <h3 class="section-subtitle">Recent Activity</h3>
            <div class="activity-list" id="recentActivityContainer">
            </div>
          </div>
        </section>

        <section id="find-rides" class="content-section">
          <div class="section-header">
            <h2 class="section-title">Find Rides</h2>
          </div>

          <div class="search-form-container">
            <form class="ride-search-form" id="rideSearchForm">
              <div class="search-row">
                <div class="form-group">
                  <label for="fromLocation" class="form-label">
                    <i class="fas fa-circle start-icon"></i>
                    From
                  </label>
                  <input
                    type="text"
                    id="fromLocation"
                    name="fromLocation"
                    class="form-input"
                    placeholder="Enter pickup location"
                    required
                  />
                </div>

                <div class="swap-locations">
                  <button
                    type="button"
                    class="swap-btn"
                    onclick="swapLocations()"
                  >
                    <i class="fas fa-exchange-alt"></i>
                  </button>
                </div>

                <div class="form-group">
                  <label for="toLocation" class="form-label">
                    <i class="fas fa-map-marker-alt end-icon"></i>
                    To
                  </label>
                  <input
                    type="text"
                    id="toLocation"
                    name="toLocation"
                    class="form-input"
                    placeholder="Enter destination"
                    required
                  />
                </div>
              </div>

              <div class="search-row">
                <div class="form-group">
                  <label for="travelDate" class="form-label">
                    <i class="fas fa-calendar"></i>
                    Date
                  </label>
                  <input
                    type="date"
                    id="travelDate"
                    name="travelDate"
                    class="form-input"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="travelTime" class="form-label">
                    <i class="fas fa-clock"></i>
                    Time
                  </label>
                  <input
                    type="time"
                    id="travelTime"
                    name="travelTime"
                    class="form-input"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="passengers" class="form-label">
                    <i class="fas fa-users"></i>
                    Passengers
                  </label>
                  <select
                    id="passengers"
                    name="passengers"
                    class="form-input"
                    required
                  >
                    <option value="1">1 passenger</option>
                    <option value="2">2 passengers</option>
                    <option value="3">3 passengers</option>
                    <option value="4">4 passengers</option>
                  </select>
                </div>
              </div>

              <button type="submit" class="search-btn">
                <i class="fas fa-search"></i>
                Search Rides
              </button>
            </form>
          </div>

          <div class="search-results" id="searchResults" style="display: none">
            <h3 class="results-title">Available Rides</h3>
            <div class="results-list" id="searchResultsList">
            </div>
          </div>
        </section>

        <section id="my-rides" class="content-section">
          <div class="section-header">
            <h2 class="section-title">My Rides</h2>
            <div class="filter-tabs">
              <button class="filter-tab active" data-filter="all">All</button>
              <button class="filter-tab" data-filter="upcoming">
                Upcoming
              </button>
              <button class="filter-tab" data-filter="completed">
                Completed
              </button>
              <button class="filter-tab" data-filter="cancelled">
                Cancelled
              </button>
            </div>
          </div>

          <div class="rides-container" id="myRidesContainer">
          </div>
        </section>
        <section id="ride-history" class="content-section">
          <div class="section-header">
            <h2 class="section-title">Ride History</h2>
          </div>
          <div class="history-summary">
            <div class="summary-card">
              <h3>This Month</h3>
              <div class="summary-stats">
                <div class="stat">
                  <span class="stat-number" id="monthRides">0</span>
                  <span class="stat-label">Rides</span>
                </div>
                <div class="stat">
                  <span class="stat-number" id="monthSpent">‚Çπ0</span>
                  <span class="stat-label">Spent</span>
                </div>
              </div>
            </div>
          </div>
          <div class="rides-container" id="rideHistoryContainer">
          </div>
        </section>

        <section id="payments" class="content-section">
          <div class="section-header">
            <h2 class="section-title">Payment Methods</h2>
          </div>
          <div class="payment-methods" id="paymentMethodsContainer">
          </div>
        </section>

        <section id="favorites" class="content-section">
          <div class="section-header">
            <h2 class="section-title">Favorite Routes</h2>
          </div>
          <div class="favorites-list" id="favoritesContainer">
          </div>
        </section>
      </div>
    </main>

    <div id="driversModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Available Drivers</h2>
          <button class="modal-close" onclick="closeDriversModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <div id="driversContainer">
          </div>
        </div>
      </div>
    </div>

    <div id="connectionModal" class="modal connection-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Send Connection Request</h2>
          <button class="modal-close" onclick="closeConnectionModal()">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="modal-body">
          <form id="connectionForm" class="connection-form">
            <div class="form-group">
              <label class="form-label">Driver</label>
              <input type="text" id="selectedDriverName" class="form-input" readonly />
            </div>
            <div class="form-group">
              <label class="form-label">From</label>
              <input type="text" id="connectionFrom" class="form-input" readonly />
            </div>
            <div class="form-group">
              <label class="form-label">To</label>
              <input type="text" id="connectionTo" class="form-input" readonly />
            </div>
            <div class="form-group">
              <label class="form-label">Date & Time</label>
              <input type="text" id="connectionDateTime" class="form-input" readonly />
            </div>
            <div class="form-group">
              <label class="form-label">Passengers</label>
              <input type="text" id="connectionPassengers" class="form-input" readonly />
            </div>
            <div class="form-group">
              <label class="form-label">Message (Optional)</label>
              <textarea id="connectionMessage" class="form-textarea" placeholder="Add a message for the driver..."></textarea>
            </div>
            <div class="connection-actions">
              <button type="button" class="btn-cancel" onclick="closeConnectionModal()">Cancel</button>
              <button type="submit" class="btn-send">
                <i class="fas fa-paper-plane"></i>
                Send Request
              </button>
            </div>
          </form>
          <!-- Moved success message to bottom of modal -->
          <div id="connectionSuccess" class="success-message" style="display: none;">
            <i class="fas fa-check-circle"></i>
            <span id="successMessage"></span>
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast">
      <div class="toast-content">
        <i class="toast-icon"></i>
        <span class="toast-message"></span>
      </div>
      <button class="toast-close">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <script>
      let currentSearchData = {};
      let selectedDriver = null;

      function checkAuthentication() {
        fetch("/api/rider-profile", {
          method: "GET",
          credentials: "include" 
        })
        .then(response => {
          if (response.status === 401) {
            window.location.href = "/rlogin";
            return;
          }
          return response.json();
        })
        .catch(error => {
          console.error("Authentication check failed:", error);
          window.location.href = "/rlogin";
        });
      }

      function logout() {
        fetch("/logout", {
          method: "POST",
          credentials: "include"
        })
        .then(response => response.json())
        .then(data => {
          showToast("Logged out successfully", "success");
          setTimeout(() => {
            window.location.href = "/rlogin";
          }, 1000);
        })
        .catch(error => {
          console.error("Logout error:", error);
          window.location.href = "/rlogin";
        });
      }

      function openDriversModal() {
        document.getElementById('driversModal').style.display = 'block';
        document.body.style.overflow = 'hidden';
      }

      function closeDriversModal() {
        document.getElementById('driversModal').style.display = 'none';
        document.body.style.overflow = 'auto';
      }

      function openConnectionModal(driver) {
        selectedDriver = driver;

        document.getElementById('selectedDriverName').value = driver.name;
        document.getElementById('connectionFrom').value = currentSearchData.from || '';
        document.getElementById('connectionTo').value = currentSearchData.to || '';
        document.getElementById('connectionDateTime').value = 
          `${currentSearchData.date || ''} at ${currentSearchData.time || ''}`;
        document.getElementById('connectionPassengers').value = 
          `${currentSearchData.passengers || '1'} passenger(s)`;

        document.getElementById('connectionMessage').value = '';
        document.getElementById('connectionSuccess').style.display = 'none';
        document.getElementById('connectionForm').style.display = 'block';
        
        document.getElementById('connectionModal').style.display = 'block';
      }

      function closeConnectionModal() {
        document.getElementById('connectionModal').style.display = 'none';
        selectedDriver = null;
      }

      window.onclick = function(event) {
        const driversModal = document.getElementById('driversModal');
        const connectionModal = document.getElementById('connectionModal');
        
        if (event.target === driversModal) {
          closeDriversModal();
        }
        if (event.target === connectionModal) {
          closeConnectionModal();
        }
      }

      document.addEventListener("DOMContentLoaded", function () {
        checkAuthentication();

        const navItems = document.querySelectorAll(".nav-item");
        const contentSections = document.querySelectorAll(".content-section");
        const toast = document.getElementById("toast");
        const profileTrigger = document.getElementById("profileTrigger");
        const profileDropdown = document.getElementById("profileDropdown");

        fetch("/api/rider-profile", {
          credentials: "include" 
        })
          .then((response) => {
            if (!response.ok) {
              if (response.status === 401) {
                window.location.href = "/rlogin";
                return;
              }
              throw new Error("Failed to load profile");
            }
            return response.json();
          })
          .then((data) => {
            const nameSpan = document.getElementById("riderProfileName");
            if (data.fullName && nameSpan) {
              const firstName = data.fullName.split(" ")[0];
              nameSpan.textContent = firstName;
              document.getElementById("welcomeName").textContent = firstName;
            }

            if (data.stats) {
              document.getElementById("totalRides").textContent =
                data.stats.totalRides || 0;
              document.getElementById("moneySaved").textContent = `‚Çπ${
                data.stats.moneySaved || 0
              }`;
              document.getElementById("userRating").textContent =
                data.stats.rating || "0.0";
              document.getElementById("carbonSaved").textContent = `${
                data.stats.carbonSaved || 0
              }kg`;
            }
          })
          .catch((error) => {
            console.error("Failed to load rider profile:", error);
            if (error.message.includes("401")) {
              window.location.href = "/rlogin";
            } else {
              showToast("Failed to load profile data", "error");
            }
          });

        fetch("/api/rider-bookings?status=upcoming", {
          credentials: "include"
        })
          .then((response) => {
            if (!response.ok) {
              if (response.status === 401) {
                window.location.href = "/rlogin";
                return;
              }
              throw new Error("Failed to load upcoming rides");
            }
            return response.json();
          })
          .then((data) => {
            const container = document.getElementById("upcomingRidesContainer");
            if (data.bookings && data.bookings.length > 0) {
              container.innerHTML = data.bookings
                .map((ride) => createRideCard(ride))
                .join("");
            } else {
              container.innerHTML = "<p>No upcoming rides found.</p>";
            }
          })
          .catch((error) => {
            console.error("Failed to load upcoming rides:", error);
          });

        fetch("/api/rider-activity", {
          credentials: "include"
        })
          .then((response) => {
            if (!response.ok) {
              if (response.status === 401) {
                window.location.href = "/rlogin";
                return;
              }
              throw new Error("Failed to load activity");
            }
            return response.json();
          })
          .then((data) => {
            const container = document.getElementById(
              "recentActivityContainer"
            );
            if (data.activities && data.activities.length > 0) {
              container.innerHTML = data.activities
                .map((activity) => createActivityItem(activity))
                .join("");
            } else {
              container.innerHTML = "<p>No recent activity found.</p>";
            }
          })
          .catch((error) => {
            console.error("Failed to load recent activity:", error);
          });

        function loadMyRides(filter = "all") {
          fetch(`/api/rider-bookings?filter=${filter}`, {
            credentials: "include"
          })
            .then((response) => {
              if (!response.ok) {
                if (response.status === 401) {
                  window.location.href = "/rlogin";
                  return;
                }
                throw new Error("Failed to load rides");
              }
              return response.json();
            })
            .then((data) => {
              const container = document.getElementById("myRidesContainer");
              if (data.bookings && data.bookings.length > 0) {
                container.innerHTML = data.bookings
                  .map((ride) => createRideCard(ride))
                  .join("");
              } else {
                container.innerHTML = "<p>No rides found.</p>";
              }
              updateRideBadge();
            })
            .catch((error) => {
              console.error("Failed to load rides:", error);
              showToast("Failed to load rides", "error");
            });
        }

        fetch("/api/rider-bookings?status=completed,cancelled", {
          credentials: "include"
        })
          .then((response) => {
            if (!response.ok) {
              if (response.status === 401) {
                window.location.href = "/rlogin";
                return;
              }
              throw new Error("Failed to load history");
            }
            return response.json();
          })
          .then((data) => {
            const container = document.getElementById("rideHistoryContainer");
            if (data.bookings && data.bookings.length > 0) {
              container.innerHTML = data.bookings
                .map((ride) => createRideCard(ride))
                .join("");

              const thisMonth = new Date().getMonth();
              const monthlyRides = data.bookings.filter((ride) => {
                const rideDate = new Date(ride.date);
                return rideDate.getMonth() === thisMonth;
              }).length;

              const monthlySpent = data.bookings.reduce((total, ride) => {
                const rideDate = new Date(ride.date);
                if (
                  rideDate.getMonth() === thisMonth &&
                  ride.status === "completed"
                ) {
                  return total + (ride.price || 0);
                }
                return total;
              }, 0);

              document.getElementById("monthRides").textContent = monthlyRides;
              document.getElementById(
                "monthSpent"
              ).textContent = `‚Çπ${monthlySpent}`;
            } else {
              container.innerHTML = "<p>No ride history found.</p>";
            }
          })
          .catch((error) => {
            console.error("Failed to load ride history:", error);
          });

        navItems.forEach((item) => {
          item.addEventListener("click", function (e) {
            e.preventDefault();

            const sectionId = this.getAttribute("data-section");
            if (sectionId) {
              showSection(sectionId);

              navItems.forEach((nav) => nav.classList.remove("active"));
              this.classList.add("active");

              if (sectionId === "my-rides") {
                loadMyRides();
              }
            }
          });
        });

        window.showSection = function (sectionId) {
          contentSections.forEach((section) => {
            section.classList.remove("active");
          });

          const targetSection = document.getElementById(sectionId);
          if (targetSection) {
            targetSection.classList.add("active");
          }

          navItems.forEach((nav) => nav.classList.remove("active"));
          const targetNav = document.querySelector(
            `[data-section="${sectionId}"]`
          );
          if (targetNav) {
            targetNav.classList.add("active");
          }
        };

        const filterTabs = document.querySelectorAll(".filter-tab");
        filterTabs.forEach((tab) => {
          tab.addEventListener("click", function () {
            const filter = this.getAttribute("data-filter");

            filterTabs.forEach((t) => t.classList.remove("active"));
            this.classList.add("active");

            loadMyRides(filter);
          });
        });

        const rideSearchForm = document.getElementById("rideSearchForm");
        if (rideSearchForm) {
          rideSearchForm.addEventListener("submit", function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            currentSearchData = {
              from: formData.get("fromLocation"),
              to: formData.get("toLocation"),
              date: formData.get("travelDate"),
              time: formData.get("travelTime"),
              passengers: formData.get("passengers"),
            };

            const searchBtn = this.querySelector(".search-btn");
            const originalText = searchBtn.innerHTML;
            searchBtn.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> Searching...';
            searchBtn.disabled = true;

            openDriversModal();
            showDriversLoading();

            fetch("/api/search-rides", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify(currentSearchData),
            })
              .then((res) => {
                if (!res.ok) {
                  if (res.status === 401) {
                    window.location.href = "/rlogin";
                    return;
                  }
                  throw new Error("Search failed");
                }
                return res.json();
              })
              .then((data) => {
                showDriversInModal(data.rides);
                
                if (data.rides.length === 0) {
                  showToast(
                    "No drivers found in your area. Please try again later!",
                    "error"
                  );
                } else {
                  const onlineCount = data.onlineDrivers || 0;
                  const offlineCount = data.offlineDrivers || 0;
                  
                  if (onlineCount === 0) {
                    showToast(
                      `Found ${data.rides.length} driver${data.rides.length > 1 ? 's' : ''}, but all are currently offline. Only online drivers can accept requests.`,
                      "warning"
                    );
                  } else {
                    showToast(
                      `Found ${data.rides.length} driver${data.rides.length > 1 ? 's' : ''}: ${onlineCount} online, ${offlineCount} offline. Only online drivers can accept requests.`,
                      "success"
                    );
                  }
                }
              })
              .catch((err) => {
                showToast("Failed to fetch drivers. Please try again.", "error");
                console.error("Search error:", err);
                closeDriversModal();
              })
              .finally(() => {
                searchBtn.innerHTML = originalText;
                searchBtn.disabled = false;
              });
          });
        }

        const connectionForm = document.getElementById('connectionForm');
        if (connectionForm) {
          connectionForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!selectedDriver) {
              showToast('No driver selected', 'error');
              return;
            }

            const submitBtn = this.querySelector('.btn-send');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
            submitBtn.disabled = true;

            const requestData = {
              driverId: selectedDriver.id,
              from: currentSearchData.from,
              to: currentSearchData.to,
              date: currentSearchData.date,
              time: currentSearchData.time,
              passengers: currentSearchData.passengers,
              message: document.getElementById('connectionMessage').value
            };

            fetch('/api/send-connection-request', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(requestData)
            })
            .then(res => {
              if (!res.ok) {
                if (res.status === 401) {
                  window.location.href = '/rlogin';
                  return;
                }
                throw new Error('Failed to send connection request');
              }
              return res.json();
            })
            .then(data => {
              // Hide the form and show success message at bottom
              document.getElementById('connectionForm').style.display = 'none';
              document.getElementById('successMessage').textContent = data.message;
              document.getElementById('connectionSuccess').style.display = 'flex';
              
              showToast(data.message, 'success');

              setTimeout(() => {
                closeConnectionModal();
              }, 3000);
            })
            .catch(err => {
              showToast(err.message || 'Failed to send connection request', 'error');
              console.error('Connection request error:', err);
            })
            .finally(() => {
              submitBtn.innerHTML = originalText;
              submitBtn.disabled = false;
            });
          });
        }

        function showDriversLoading() {
          const container = document.getElementById('driversContainer');
          container.innerHTML = `
            <div class="loading-spinner">
              <div class="spinner"></div>
            </div>
          `;
        }

        function showDriversInModal(drivers) {
          const container = document.getElementById('driversContainer');
          
          if (!drivers || drivers.length === 0) {
            container.innerHTML = `
              <div class="no-drivers">
                <i class="fas fa-car"></i>
                <h3>No drivers found</h3>
                <p>No drivers are available in your area. Please try again later.</p>
                <small>üí° Tip: Try searching at different times when more drivers might be available.</small>
              </div>
            `;
            return;
          }

          // Count online and offline drivers
          const onlineCount = drivers.filter(d => d.isOnline).length;
          const offlineCount = drivers.filter(d => !d.isOnline).length;

          container.innerHTML = `
            <div class="drivers-filter">
              <button class="filter-btn active" data-filter="all">
                All Drivers (${drivers.length})
              </button>
              <button class="filter-btn" data-filter="online">
                <span class="status-dot online"></span>
                Online (${onlineCount})
              </button>
              <button class="filter-btn" data-filter="offline">
                <span class="status-dot offline"></span>
                Offline (${offlineCount})
              </button>
            </div>
            <div class="filter-info">
              <small class="filter-note online-note">‚úÖ Only online drivers can accept ride requests</small>
              <small class="filter-note offline-note" style="display: none;">‚ö†Ô∏è Offline drivers cannot accept requests right now</small>
            </div>
            <div class="drivers-grid" id="driversGrid">
              ${drivers.map(driver => createDriverCard(driver)).join('')}
            </div>
          `;

          const filterBtns = container.querySelectorAll('.filter-btn');
          const onlineNote = container.querySelector('.online-note');
          const offlineNote = container.querySelector('.offline-note');
          
          filterBtns.forEach(btn => {
            btn.addEventListener('click', function() {
              const filter = this.dataset.filter;

              filterBtns.forEach(b => b.classList.remove('active'));
              this.classList.add('active');

              let filteredDrivers = drivers;
              if (filter === 'online') {
                filteredDrivers = drivers.filter(d => d.isOnline);
                onlineNote.style.display = 'block';
                offlineNote.style.display = 'none';
              } else if (filter === 'offline') {
                filteredDrivers = drivers.filter(d => !d.isOnline);
                onlineNote.style.display = 'none';
                offlineNote.style.display = 'block';
              } else {
                // Show all drivers
                onlineNote.style.display = 'block';
                offlineNote.style.display = 'none';
              }

              const grid = document.getElementById('driversGrid');
              if (filteredDrivers.length === 0) {
                const noDriversMessage = filter === 'online' 
                  ? 'No drivers are currently online' 
                  : filter === 'offline' 
                  ? 'No drivers are currently offline' 
                  : 'No drivers found';
                  
                grid.innerHTML = `
                  <div class="no-drivers-filtered">
                    <i class="fas fa-search"></i>
                    <h4>${noDriversMessage}</h4>
                    <p>Try selecting a different filter option.</p>
                  </div>
                `;
              } else {
                grid.innerHTML = filteredDrivers.map(driver => createDriverCard(driver)).join('');
              }
            });
          });
        }

        function createDriverCard(driver) {
          const statusClass = driver.isOnline ? 'online' : 'offline';
          const statusText = driver.isOnline ? 'Online' : 'Offline';
          
          // Use profile.jpeg instead of default profile image
          const profileImage = driver.driver.profileImage && driver.driver.profileImage !== '/images/default.png' 
            ? driver.driver.profileImage 
            : '/images/profile.jpeg';
          
          return `
            <div class="driver-card ${statusClass}">
              <div class="driver-header">
                <img src="${profileImage}" alt="${driver.driver.name}" class="driver-avatar">
                <div class="driver-info">
                  <h3>${driver.driver.name}</h3>
                  <div class="driver-rating">
                    <i class="fas fa-star"></i>
                    <span>${driver.driver.rating}</span>
                    <span>(${Math.floor(Math.random() * 50) + 10} reviews)</span>
                  </div>
                  <div class="driver-status ${statusClass}">
                    <span class="status-dot ${statusClass}"></span>
                    <span>${statusText}</span>
                  </div>
                </div>
              </div>
              
              <div class="driver-details">
                <div class="detail-item">
                  <i class="fas fa-car"></i>
                  <span>${driver.vehicle.model}</span>
                </div>
                <div class="detail-item">
                  <i class="fas fa-palette"></i>
                  <span>${driver.vehicle.color}</span>
                </div>
                <div class="detail-item">
                  <i class="fas fa-users"></i>
                  <span>${driver.availableSeats} seats</span>
                </div>
                <div class="detail-item">
                  <i class="fas fa-map-marker-alt"></i>
                  <span>${driver.city}</span>
                </div>
                <div class="detail-item">
                  <i class="fas fa-rupee-sign"></i>
                  <span>‚Çπ${driver.pricePerSeat}/seat</span>
                </div>
                <div class="detail-item">
                  <i class="fas fa-id-card"></i>
                  <span>${driver.vehicle.licensePlate}</span>
                </div>
              </div>
              
              <div class="driver-actions">
                <button class="btn-view-profile" onclick="viewDriverProfile('${driver.driver.id}')">
                  <i class="fas fa-user"></i>
                  View Profile
                </button>
                <button class="btn-connect ${driver.isOnline ? '' : 'disabled'}" 
                        onclick="connectToDriver('${driver.driver.id}', '${driver.driver.name}')"
                        ${driver.isOnline ? '' : 'disabled'}>
                  <i class="fas fa-link"></i>
                  ${driver.isOnline ? 'Connect' : 'Offline'}
                </button>
              </div>
            </div>
          `;
        }

        window.connectToDriver = function(driverId, driverName) {
          // Find the driver card to check if driver is online
          const driverCards = document.querySelectorAll('.driver-card');
          let isDriverOnline = false;
          
          driverCards.forEach(card => {
            const connectBtn = card.querySelector('.btn-connect');
            if (connectBtn && connectBtn.onclick && connectBtn.onclick.toString().includes(driverId)) {
              isDriverOnline = !card.classList.contains('offline');
            }
          });
          
          if (!isDriverOnline) {
            showToast('This driver is currently offline and cannot accept requests.', 'error');
            return;
          }
          
          const driver = {
            id: driverId,
            name: driverName
          };
          openConnectionModal(driver);
        };

        function showSearchResults(rides) {
          const resultsContainer = document.getElementById("searchResultsList");
          resultsContainer.innerHTML = "";

          if (!rides || rides.length === 0) {
            resultsContainer.innerHTML =
              "<p>No rides found matching your criteria.</p>";
            document.getElementById("searchResults").style.display = "block";
            return;
          }

          rides.forEach((ride) => {
            const rideCard = document.createElement("div");
            rideCard.className = "ride-card search-result";
            
            // Use profile.jpeg instead of default profile image
            const profileImage = ride.driver.profileImage && ride.driver.profileImage !== '/images/default.png' 
              ? ride.driver.profileImage 
              : '/images/profile.jpeg';
            
            rideCard.innerHTML = `
                        <div class="ride-header">
                            <div class="ride-route">
                                <div class="route-point start">
                                    <i class="fas fa-circle"></i>
                                    <span>${
                                      ride.origin.address || ride.origin
                                    }</span>
                                </div>
                                <div class="route-line">
                                    <i class="fas fa-arrow-right"></i>
                                </div>
                                <div class="route-point end">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${
                                      ride.destination.address ||
                                      ride.destination
                                    }</span>
                                </div>
                            </div>
                            <div class="ride-time">
                                <i class="fas fa-clock"></i>
                                <span>${new Date(
                                  ride.departureTime
                                ).toLocaleTimeString([], {
                                  hour: "2-digit",
                                  minute: "2-digit",
                                })}</span>
                            </div>
                        </div>

                        <div class="ride-details">
                            <div class="driver-info">
                                <img src="${profileImage}" alt="Driver" class="driver-avatar">
                                <div class="driver-details">
                                    <div class="driver-name">${
                                      ride.driver.name
                                    }</div>
                                    <div class="driver-rating">
                                        <i class="fas fa-star"></i>
                                        <span>${
                                          ride.driver.rating || "N/A"
                                        }</span>
                                    </div>
                                </div>
                            </div>

                            <div class="ride-info">
                                <div class="info-item">
                                    <i class="fas fa-car"></i>
                                    <span>${
                                      ride.vehicle.model || "Not specified"
                                    }</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-users"></i>
                                    <span>${ride.availableSeats} seats</span>
                                </div>
                                <div class="info-item">
                                    <i class="fas fa-rupee-sign"></i>
                                    <span>‚Çπ${ride.pricePerSeat}</span>
                                </div>
                            </div>
                        </div>

                        <div class="ride-actions">
                            <button class="action-btn secondary" onclick="viewDriverProfile('${
                              ride.driver.id
                            }')">
                                <i class="fas fa-user"></i>
                                View Profile
                            </button>
                            <button class="action-btn primary" onclick="bookRide('${
                              ride.id
                            }')">
                                <i class="fas fa-check"></i>
                                Book Ride
                            </button>
                        </div>
                    `;
            resultsContainer.appendChild(rideCard);
          });

          document.getElementById("searchResults").style.display = "block";
        }

        function createRideCard(ride) {
          // Use profile.jpeg instead of default profile image
          const profileImage = ride.driver.avatar && ride.driver.avatar !== '/images/default.png' 
            ? ride.driver.avatar 
            : '/images/profile.jpeg';
            
          return `
                    <div class="ride-card" data-status="${
                      ride.status
                    }" data-ride-id="${ride.id}">
                        <div class="ride-header">
                            <div class="ride-route">
                                <div class="route-point start">
                                    <i class="fas fa-circle"></i>
                                    <span>${ride.origin}</span>
                                </div>
                                <div class="route-line">
                                    <i class="fas fa-arrow-right"></i>
                                </div>
                                <div class="route-point end">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>${ride.destination}</span>
                                </div>
                            </div>
                            <div class="ride-time">
                                <i class="fas fa-clock"></i>
                                <span>${new Date(
                                  ride.date
                                ).toLocaleDateString()}, ${ride.time}</span>
                            </div>
                        </div>

                        <div class="ride-details">
                            <div class="driver-info">
                                <img src="${profileImage}" alt="Driver" class="driver-avatar">
                                <div class="driver-details">
                                    <div class="driver-name">${
                                      ride.driver.name
                                    }</div>
                                    <div class="driver-rating">
                                        <i class="fas fa-star"></i>
                                        <span>${
                                          ride.driver.rating || "N/A"
                                        }</span>
                                    </div>
                                </div>
                            </div>

                            <div class="ride-info">
                                <div class="info-item">
                                    <i class="fas fa-car"></i>
                                    <span>${
                                      ride.vehicle || "Not specified"
                                    }</span>
                                </div>
                                ${
                                  ride.status === "completed"
                                    ? `
                                <div class="info-item">
                                    <i class="fas fa-rupee-sign"></i>
                                    <span>‚Çπ${ride.price || "0"}</span>
                                </div>
                                `
                                    : ""
                                }
                            </div>
                        </div>

                        <div class="ride-actions">
                            ${
                              ride.status === "upcoming"
                                ? `
                            <button class="action-btn secondary" onclick="contactDriver('${ride.driver.id}')">
                                <i class="fas fa-phone"></i>
                                Contact
                            </button>
                            <button class="action-btn danger" onclick="cancelRide(this, '${ride.id}')">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            `
                                : ride.status === "completed"
                                ? `
                            <button class="action-btn secondary" onclick="viewReceipt('${ride.id}')">
                                <i class="fas fa-receipt"></i>
                                View Receipt
                            </button>
                            <button class="action-btn primary" onclick="rateDriver('${ride.driver.id}')">
                                <i class="fas fa-star"></i>
                                Rate Driver
                            </button>
                            `
                                : ""
                            }
                        </div>
                        
                        <div class="ride-status ${ride.status}">
                            <i class="fas ${
                              ride.status === "upcoming"
                                ? "fa-clock"
                                : ride.status === "completed"
                                ? "fa-check-circle"
                                : ride.status === "accepted"
                                ? "fa-check-circle"
                                : ride.status === "pending"
                                ? "fa-clock"
                                : "fa-times-circle"
                            }"></i>
                            <span>${
                              ride.status === "accepted" ? "Accepted!" :
                              ride.status === "pending" ? "Pending!" :
                              ride.status.charAt(0).toUpperCase() +
                              ride.status.slice(1)
                            }</span>
                        </div>
                    </div>
                `;
        }

        function createActivityItem(activity) {
          return `
                    <div class="activity-item">
                        <div class="activity-icon ${activity.type}">
                            <i class="fas ${
                              activity.type === "completed"
                                ? "fa-check"
                                : activity.type === "rating"
                                ? "fa-star"
                                : "fa-calendar-plus"
                            }"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-text">${activity.text}</div>
                            <div class="activity-time">${new Date(
                              activity.timestamp
                            ).toLocaleString()}</div>
                        </div>
                    </div>
                `;
        }

        window.swapLocations = function () {
          const fromInput = document.getElementById("fromLocation");
          const toInput = document.getElementById("toLocation");

          if (fromInput && toInput) {
            const temp = fromInput.value;
            fromInput.value = toInput.value;
            toInput.value = temp;

            const swapBtn = document.querySelector(".swap-btn");
            swapBtn.style.transform = "rotate(180deg)";
            setTimeout(() => {
              swapBtn.style.transform = "rotate(0deg)";
            }, 300);
          }
        };

        window.bookRide = function (rideId) {
          showToast("Processing your booking...", "success");

          fetch("/api/book-ride", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
              rideId
            }),
          })
            .then((res) => {
              if (!res.ok) {
                if (res.status === 401) {
                  window.location.href = "/rlogin";
                  return;
                }
                throw new Error("Booking failed");
              }
              return res.json();
            })
            .then((data) => {
              showToast(data.message || "Ride booked successfully!", "success");
              updateRideBadge();
              showSection("my-rides");
              loadMyRides();
            })
            .catch((err) => {
              showToast(
                err.message || "Booking failed. Please try again.",
                "error"
              );
              console.error("Booking error:", err);
            });
        };

        window.viewDriverProfile = function (driverId) {
          window.location.href = `/driver-profile.html?id=${driverId}`;
        };

        window.contactDriver = function (driverId) {
          fetch(`/api/driver-contact/${driverId}`, {
            credentials: "include"
          })
            .then((res) => {
              if (!res.ok) {
                if (res.status === 401) {
                  window.location.href = "/rlogin";
                  return;
                }
                throw new Error("Failed to get contact info");
              }
              return res.json();
            })
            .then((data) => {
              showToast(`Call driver at ${data.phone}`, "success");
            })
            .catch((err) => {
              showToast("Failed to get contact info", "error");
              console.error("Contact error:", err);
            });
        };

        window.cancelRide = function (button, rideId) {
          if (!confirm("Are you sure you want to cancel this ride?")) return;

          button.innerHTML =
            '<i class="fas fa-spinner fa-spin"></i> Cancelling...';
          button.disabled = true;

          fetch("/api/cancel-ride", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
              rideId
            }),
          })
            .then((res) => {
              if (!res.ok) {
                if (res.status === 401) {
                  window.location.href = "/rlogin";
                  return;
                }
                throw new Error("Cancellation failed");
              }
              return res.json();
            })
            .then((data) => {
              showToast(data.message || "Ride cancelled successfully", "error");
              updateRideBadge();

              const rideCard = button.closest(".ride-card");
              rideCard.style.opacity = "0";
              rideCard.style.transform = "translateX(-100%)";

              setTimeout(() => {
                rideCard.remove();
              }, 300);
            })
            .catch((err) => {
              showToast(err.message || "Failed to cancel ride", "error");
              console.error("Cancel error:", err);
              button.innerHTML = '<i class="fas fa-times"></i> Cancel';
              button.disabled = false;
            });
        };

        window.viewReceipt = function (rideId) {
          window.location.href = `/receipt.html?rideId=${rideId}`;
        };

        window.rateDriver = function (driverId) {
          const rating = prompt("Rate this driver (1-5 stars):");
          if (rating && rating >= 1 && rating <= 5) {
            fetch("/api/rate-driver", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({
                driverId,
                rating,
              }),
            })
              .then((res) => {
                if (!res.ok) {
                  if (res.status === 401) {
                    window.location.href = "/rlogin";
                    return;
                  }
                  throw new Error("Rating failed");
                }
                return res.json();
              })
              .then((data) => {
                showToast(
                  data.message || "Thank you for your rating!",
                  "success"
                );
              })
              .catch((err) => {
                showToast(err.message || "Failed to submit rating", "error");
                console.error("Rating error:", err);
              });
          }
        };
        function updateRideBadge() {
          fetch(`/api/rider-bookings?status=upcoming`, {
            credentials: "include"
          })
            .then((res) => {
              if (!res.ok) {
                if (res.status === 401) {
                  window.location.href = "/rlogin";
                  return;
                }
                throw new Error("Failed to update badge");
              }
              return res.json();
            })
            .then((data) => {
              const count = data.bookings ? data.bookings.length : 0;
              const badge = document.querySelector(
                '.nav-item[data-section="my-rides"] .nav-badge'
              );
              const notificationBadge = document.querySelector(
                ".notification-badge"
              );

              if (badge) {
                badge.textContent = count;
                badge.style.display = count > 0 ? "inline" : "none";
              }

              if (notificationBadge) {
                notificationBadge.textContent = count;
                notificationBadge.style.display = count > 0 ? "block" : "none";
              }
            })
            .catch((error) => {
              console.error("Error updating badge:", error);
            });
        }

        function showToast(message, type = "success") {
          const toastIcon = toast.querySelector(".toast-icon");
          const toastMessage = toast.querySelector(".toast-message");
          const toastClose = toast.querySelector(".toast-close");
          toastMessage.textContent = message;
          toast.className = `toast ${type}`;

          if (type === "success") {
            toastIcon.className = "fas fa-check-circle toast-icon";
          } else if (type === "error") {
            toastIcon.className = "fas fa-exclamation-circle toast-icon";
          }

          toast.classList.add("show");

          const autoHideTimer = setTimeout(() => {
            hideToast();
          }, 5000);

          toastClose.onclick = () => {
            clearTimeout(autoHideTimer);
            hideToast();
          };
        }

        function hideToast() {
          toast.classList.remove("show");
        }

        if (profileTrigger && profileDropdown) {
          document.addEventListener("click", function (e) {
            if (!profileTrigger.contains(e.target)) {
              profileDropdown.style.opacity = "0";
              profileDropdown.style.visibility = "hidden";
              profileDropdown.style.transform = "translateY(-10px)";
            }
          });

          profileTrigger.addEventListener("click", function (e) {
            e.stopPropagation();
            const isVisible = profileDropdown.style.visibility === "visible";

            if (isVisible) {
              profileDropdown.style.opacity = "0";
              profileDropdown.style.visibility = "hidden";
              profileDropdown.style.transform = "translateY(-10px)";
            } else {
              profileDropdown.style.opacity = "1";
              profileDropdown.style.visibility = "visible";
              profileDropdown.style.transform = "translateY(0)";
            }
          });
        }

        const travelDateInput = document.getElementById("travelDate");
        const travelTimeInput = document.getElementById("travelTime");

        if (travelDateInput) {
          const today = new Date();
          travelDateInput.value = today.toISOString().split("T")[0];
        }

        if (travelTimeInput) {
          const now = new Date();
          const hours = String(now.getHours()).padStart(2, "0");
          const minutes = String(now.getMinutes()).padStart(2, "0");
          travelTimeInput.value = `${hours}:${minutes}`;
        }

        setTimeout(() => {
          const cards = document.querySelectorAll(
            ".stat-card, .ride-card, .activity-item"
          );
          cards.forEach((card, index) => {
            card.style.opacity = "0";
            card.style.transform = "translateY(20px)";
            card.style.transition = "opacity 0.6s ease, transform 0.6s ease";

            setTimeout(() => {
              card.style.opacity = "1";
              card.style.transform = "translateY(0)";
            }, index * 100);
          });

          updateRideBadge();
        }, 100);

        function createMobileToggle() {
          if (window.innerWidth <= 768) {
            const header = document.querySelector(
              ".dashboard-header .header-container"
            );
            const sidebar = document.querySelector(".dashboard-sidebar");

            let mobileToggle = document.querySelector(".mobile-sidebar-toggle");
            if (!mobileToggle) {
              mobileToggle = document.createElement("button");
              mobileToggle.className = "mobile-sidebar-toggle";
              mobileToggle.innerHTML = '<i class="fas fa-bars"></i>';
              mobileToggle.style.cssText = `
                            background: none;
                            border: none;
                            font-size: 1.25rem;
                            color: var(--gray-600);
                            cursor: pointer;
                            padding: 0.5rem;
                            border-radiuas: 0.5rem;
                            transition: background 0.15s ease;
                        `;

              mobileToggle.addEventListener("click", function () {
                sidebar.classList.toggle("open");
              });

              header.insertBefore(mobileToggle, header.firstChild);
            }
          }
        }

        createMobileToggle();

        window.addEventListener("resize", createMobileToggle);
      });
    </script>
  </body>
</html>

